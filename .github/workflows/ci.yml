name: CI - Lint and Test

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master, develop]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install linting tools
        run: |
          pip install yamllint
          sudo apt-get update
          sudo apt-get install -y shellcheck

      - name: Lint YAML files
        run: |
          echo "Linting YAML files..."
          yamllint -d '{extends: relaxed, rules: {line-length: {max: 200}}}' .github/workflows/ examples/

      - name: Lint shell scripts
        run: |
          echo "Linting shell scripts..."
          shellcheck scripts/*.sh

      - name: Lint GitHub Actions workflows
        uses: docker://rhysd/actionlint:latest
        with:
          args: -color

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install BATS
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: Run BATS tests
        id: bats-tests
        continue-on-error: true
        run: |
          echo "Running BATS test suite..."
          bats tests/ --print-output-on-failure --formatter tap

      - name: Test report
        if: always()
        run: |
          {
            echo "### Test Results"
            echo ""
            if [ "${{ steps.bats-tests.outcome }}" == "success" ]; then
              echo "âœ… All tests passed!"
            else
              echo "âŒ Some tests failed. Check logs above."
            fi
          } >> "$GITHUB_STEP_SUMMARY"

  validate-examples:
    name: Validate Examples
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Validate example workflows
        run: |
          echo "Validating example workflows..."
          for example in examples/*.yml; do
            echo "Checking $example..."
            # Check that examples reference the correct workflow
            if ! grep -q "stuartshay/shared-azure-health/.github/workflows/destroy-infrastructure.yml@master" "$example"; then
              echo "âŒ $example does not reference the shared workflow correctly"
              exit 1
            fi
            # Check that examples have required inputs
            if ! grep -q "project-name:" "$example"; then
              echo "âŒ $example is missing project-name input"
              exit 1
            fi
            if ! grep -q "environment:" "$example"; then
              echo "âŒ $example is missing environment input"
              exit 1
            fi
            if ! grep -q "resource-group:" "$example"; then
              echo "âŒ $example is missing resource-group input"
              exit 1
            fi
            echo "âœ… $example is valid"
          done
          echo "All examples validated successfully!"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [lint, test, validate-examples]
    if: always()

    steps:
      - name: Generate summary
        run: |
          {
            echo "### CI Results"
            echo ""
            echo "| Job | Status |"
            echo "|-----|--------|"
            echo "| Lint | ${{ needs.lint.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |"
            echo "| Test | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |"
            echo "| Validate Examples | ${{ needs.validate-examples.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |"
            echo ""
          } >> "$GITHUB_STEP_SUMMARY"

          if [ "${{ needs.lint.result }}" == "success" ] && [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.validate-examples.result }}" == "success" ]; then
            echo "ðŸŽ‰ **All checks passed!** This code is ready to merge." >> "$GITHUB_STEP_SUMMARY"
            exit 0
          else
            echo "âš ï¸ **Some checks failed.** Please review the logs and fix the issues." >> "$GITHUB_STEP_SUMMARY"
            exit 1
          fi
